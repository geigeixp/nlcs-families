# NLCS Families 小程序开发日志

这份文档总结了 NLCS Families 小程序从开发至今的所有主要功能模块、技术决策以及关键问题的解决方案。

## 1. 核心功能模块

### 1.1 用户认证与管理
- **注册流程** (`pages/register`): 家长提交申请，包含学生信息（姓名、年级、关系）。
- **多子女支持**:
  - 允许添加多个孩子 (`pages/child-info`)。
  - 个人主页显示格式为 "Child1 & Child2 妈妈"。
  - 班级显示格式为 "7C & 4A"。
- **管理员审核** (`pages/admin`):
  - 管理员可查看待审核列表 (`listApplications`)。
  - 执行批准 (`reviewApplication`) 或驳回操作。
  - 严格权限控制：未审核用户无法查看社区、校友录等核心内容。
- **个人中心** (`pages/profile`):
  - 展示用户身份、审核状态。
  - 动态计算并展示红点提示（未读消息、待审核任务）。

### 1.2 社区互动 (Community)
- **帖子流** (`pages/index`):
  - 支持分类筛选（闲置转让、活动召集等）。
  - 支持按最新/最热排序。
  - 支持关键词搜索（集成 DeepSeek AI 增强搜索）。
- **发帖与编辑**:
  - 发布带图片的帖子 (`pages/post`)。
  - 编辑已发布帖子 (`pages/edit-post`)。
  - 删除自己的帖子 (`deletePost`)。
- **互动功能**:
  - 点赞 (`toggleLike`): 支持帖子点赞，实时更新计数。
  - 评论 (`addComment`): 支持对帖子进行评论。
  - 评论点赞 (`toggleCommentLike`): 支持对评论进行点赞。
  - 评论编辑与删除: 用户可管理自己的评论。
- **详情页** (`pages/post-detail`):
  - 完整的帖子内容展示。
  - 评论列表展示。
  - 优化了作者信息和评论区的 UI 布局。

### 1.3 消息通知系统
- **通知中心** (`pages/messages`):
  - 聚合显示收到的点赞和评论。
  - 支持点击通知跳转至对应帖子详情。
  - **红点逻辑**:
    - 基于时间戳的智能未读判断。
    - 解决了客户端与服务器时间偏差导致的红点不消失问题。
  - **一键清除**: 提供清除所有消息的功能（逻辑删除）。
- **红点提示**:
  - 底部 TabBar "我的" 红点。
  - 个人中心 "消息通知"、"我的发布" 菜单项红点。
  - 管理员 "管理员后台" 待审核红点。

### 1.4 校友录 (Alumni)
- **校友列表** (`pages/alumni`):
  - 展示已认证家长的列表。
  - 支持点击查看校友详细资料卡片。
- **布局优化**:
  - 针对宽屏/全屏布局进行了样式覆盖 (`align-items: stretch`)。

### 1.5 资源与文档
- **文档中心** (`pages/documents`):
  - 提供校历、手册等 PDF 文档下载与预览。
  - 实现了文件上传的重试机制 (`uploadWithRetry`) 以应对网络不稳定。

## 2. 关键技术改进与修复

### 2.1 数据一致性与规范
- **班级名称统一**:
  - 实施了强制格式化规则，将所有 "G7C", "Grade 7C" 等输入统一转换为 "7C" 格式。
  - 涉及前端输入拦截 (`pages/child-info`) 和可能的后台数据清洗。
- **字段命名规范**:
  - 统一了云函数间的字段调用（如 `_openid` vs `openid`）。
  - 修正了 `createTime` (评论) 与 `createdAt` (点赞) 的混用问题。

### 2.2 用户体验优化 (UX)
- **网络鲁棒性**:
  - 为所有文件上传操作添加了自动重试机制，解决了 "UserNetworkTooSlow" 错误。
- **头像处理**:
  - 修复了微信头像 URL 过期导致的 404/403 错误，增加了本地默认头像回退机制。
  - 后台自动清洗失效头像 URL。
- **即时反馈**:
  - 优化了点赞/评论的乐观更新（Optimistic UI），让界面响应更快。
  - 消息红点在阅读后立即消失，无需刷新。

### 2.3 管理员后台体验
- **入口优化**: 将 "管理员审核" 更名为 "管理员后台"，并在菜单项上直接显示待办红点。
- **数据获取**: 优化了 `listApplications` 云函数，支持分页和搜索。

## 3. 云函数架构
目前项目包含 30+ 个云函数，主要分为以下几类：
- **核心业务**: `submitApplication`, `getPosts`, `addComment`
- **数据查询**: `getMessages`, `getMyUnread`, `getAlumni`
- **管理后台**: `listApplications`, `reviewApplication`, `manageAdmin`
- **工具/维护**: `fixClassNames`, `migrateGrades`, `clearMessages`

## 4. 遗留与待办
- **性能优化**: 随着帖子数量增加，`getPosts` 和 `getMessages` 的查询效率可能需要进一步索引优化。
- **搜索增强**: DeepSeek AI 的集成目前主要用于内容搜索，未来可扩展至智能问答。

---
*最后更新时间: 2026-01-11*
